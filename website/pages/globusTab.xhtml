<!DOCTYPE html PUBLIC "-/W3C/DTD XHTML 1.0 Transitional/EN" "http:/www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:t="http://myfaces.apache.org/tomahawk"
      xmlns:a4j="https://ajax4jsf.dev.java.net/ajax">
<ui:composition>
    <ui:define name="headText">
        <script type="text/javascript" language="javascript">
            /* <![CDATA[ */

            var globus_enabled = #{loginBean.globusEnabled};
           
            
            
            window.globus_tab_init = false;
            function init_globus_tab() {
                if (window.globus_tab_init) return;
       
               // $("#glbBrowseForm").append('<input type="text" name="gp_session_id" value="'+getCookie("JSESSIONID")+'" />');
                try { 
                var oldAction = $("#globusAction")[0].value;
                var sessionId = getCookie("JSESSIONID");
               
                
			    if (oldAction.indexOf("gp_session_id") <1){
			    	$("#globusAction")[0].value = oldAction + "?gp_session_id="+ sessionId+"&gp_username="+username;
			    }

                window.globus_tab_init = true;
                
                // check for any transfers upon startup
                getGlobusTransferStatus();
                } catch (error){
                	console.log("globus init failed.  not logged into globus?");
                	
                }
            }

           
          
            
              
			 

            function clearGlobusTransfers(){
            	$.ajax({
                    cache: false,
                    type: "GET",
                    url: "/gp/rest/v1/globus/clearCompletedTasks",
                    dataType: "json",
                    success: function(data) {
                    	// clear things out
                    	$("#glb-transfer-list").html("");
                    	// go get any still running
                    	getGlobusTransferStatus();
                    
                    },
                    error: function(data){
                    	console.log("FAIL");
                    }
            	});
            	
            }
            
            
            function globusTransferInitiated(){
            	console.log("Globus file transfer initiated");
            	
            	$("#glb-transfer-initiated").show();
            	// leave the transfer list in whatever state it is in 
            	// to be updated at the next check status
            	
            }
            
            function formatBytes(bytes,decimals) {
            	   if(bytes == 0) return '0 Bytes';
            	   var k = 1024,
            	       dm = decimals || 2,
            	       sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
            	       i = Math.floor(Math.log(bytes) / Math.log(k));
            	   return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            	}
            
            function createTransferTaskDiv(task) {
            	var timeCheck = new Date(Number(task.lastStatusCheckTime));
            	var taskDiv;
            	var titleDiv;
            	var wrapperDiv;
            	var oldTask = $("#transfer_wrapper_"+task.id)[0];
            	
            	// XXX
            	
            	if (oldTask != null){
            		taskDiv = $("#transfer_"+task.id);
            		titleDiv = $("#transfer_title_"+task.id);
                	$(titleDiv).removeClass(); // remove all classes
            		
            	} else {
            		titleDiv = $("<div id='transfer_title_"+task.id+"' >  "+task.file+"</div>");
               		var titleOpenImg = $("<img id='transfer_open_"+task.id+"' src='../images/triangle_black_run.gif'/>");
               		var titleClosedImg = $("<img id='transfer_closed_"+task.id+"' src='../images/triangle_black.gif' style='display:none' />");
               		$(titleDiv).prepend(titleOpenImg);
               		$(titleDiv).prepend(titleClosedImg);
               		
               		
               		
               		taskDiv = $("<div id='transfer_"+task.id+"'></div>");
               		
    				$(titleDiv).click(function(e){
    					$("#transfer_"+task.id).toggle();
    					$("#transfer_open_"+task.id).toggle();
    					$("#transfer_closed_"+task.id).toggle();
    					});
    				wrapperDiv = $("<div id='transfer_wrapper_"+task.id+"'></div>");
               		$(taskDiv).addClass("globusTransferListing");
               		wrapperDiv.append(titleDiv);
               		wrapperDiv.append(taskDiv);
               		$("#glb-transfer-list").prepend(wrapperDiv);
            	}
            	
            	// update the status section and class for the title
              	$(titleDiv).addClass("globusTransferStatus_"+ task.status);
              	$(titleDiv).addClass("globusTransferTitle");
              	// clear the task div
              	$(taskDiv).html("");
              	
           		//$(taskDiv).append("<span>ID: "+task.id+"</span><br/>");
           		$(taskDiv).append("<span>STATUS: "+ task.status+"</span><br/>");
           		if (task.error != null){
           			$(taskDiv).append("<span>ERROR: "+ task.error +"</span><br/>");
           		}
           		if (task.statusObject != null){
           			var nBytes = task.statusObject.bytes_transferred;
           			if (nBytes == null) {
           				nBytes = "0";
           			} else {
           				nBytes = formatBytes(nBytes);
           			}
           			
           			var timeString = "";
           			if (task.statusObject.completion_time != null){
	           			timeCheck =  new Date(task.statusObject.completion_time) ;
	           		} 	
           			timeString = "\nas of "+ timeCheck.toLocaleString();
	           		
           			
           			if (task.error != null){
           			  // put the details in the hover
                   		$(titleDiv).attr('title', "ERROR:" + task.error + "\n" +nBytes+" transferred" + timeString);
               		} else {
               		  // put the details in the hover
                   		$(titleDiv).attr('title', task.status + "\n" +nBytes+" transferred "+ timeString);
               		}
           		  
               		
           			
	           		$(taskDiv).append("<span>bytes transferred:"+nBytes+"</span><br/>");
	           		
	           		
           		}
           		$(taskDiv).append("<span>as of "+timeCheck.toLocaleString()+"</span><br/>");
           		
           		
           		
           		return wrapperDiv;
            }
            
            function getGlobusTransferStatus(){
            	$.ajax({
                    cache: false,
                    type: "GET",
                    url: "/gp/rest/v1/globus/currentTasks",
                    dataType: "json",
                    success: function(data) {
                    
                    	$("#glb-transfer-initiated").hide();
                    	
                    	$('#glb-clear').prop("disabled",true);
                    	$('#glb-clear').hide();
                    	
                    	var anyRunning = false;
                    	//$("#glb-transfer-list").empty();
                    	if (data.length > 0){
                        	for (var i=0; i < data.length; i++){
                        		var task = data[i];
                         		createTransferTaskDiv(task);
         	                    if (task.status == "ACTIVE") anyRunning = true;
         	                    else {
         	                    	$('#glb-clear').prop("disabled",false);
         	                    	$('#glb-clear').show();
         	                    }
	                    	}
                        	$("#glb-transfer-list").show();
	                 	} 
                    	
                    	// check back once a minute if any are still running
                    	if (anyRunning){
                    		setTimeout( function(){ 
                    		    getGlobusTransferStatus();
                    		  }  , 60000 );
                    	} else {
                    		setTimeout( function(){ 
                    		    getGlobusTransferStatus();
                    		  }  , 180000 );
                    		
                    	}
                    	// finally refresh the files tab to make sure it shows any recent additions
                    	refreshUploadTree();
                    	
                    },
                    error: function(data){
                    	
                    }
            	});
            	
            	
            	
            	
            }
            
            // Load the notebooks tab
            $(document).ready(init_globus_tab);

            /* ]]> */
        </script>
        
    </ui:define>

    <div class="left-nav-top">
        <t:div  styleClass="glbRight" rendered="#{not userPrefsBean.globusLinked}">
	             <h:outputLink
	                value="#{facesContext.externalContext.requestContextPath}/oauthglobus">Authenticate with Globus</h:outputLink>
	    </t:div>
        <t:div styleClass="glbRight"  rendered="#{userPrefsBean.globusLinked}">
            <button id="glb-clear" onclick="clearGlobusTransfers();" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false" >
	            Clear completed
	        </button>
	        
        </t:div>
        
    </div>
    
    <br/>
    <div id="glbMain" >
<!--         <button id="glb-refresh-transferlist" onclick="getGlobusTransferStatus();false"  -->
<!--         			class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false"> -->
<!-- 	            Refresh  -->
<!-- 	    </button> -->
	    
       <div id="glb-transfer-initiated" style="display:none;">
          Globus transfer status will be updated in 1 minute.
       </div>
       <div id="glb-transfer-list" style="display:none;">
       </div>
       
        
    </div>
    
    <div id="glbInfo" class="info-box sidebarhead-bkg">
    Transfer files from Globus to GenePattern.<br/>
       To learn more about
        <a href="https://www.genepattern.org/" target="_blank">GenePattern and Globus Integration, click here</a>.
    </div>

</ui:composition>
</html>
